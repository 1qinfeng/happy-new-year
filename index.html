<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <!-- å…³é”®ï¼šæ·»åŠ  viewport-fit=cover é€‚é…å…¨é¢å± -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>2026 é©¬å¹´æ–°æ˜¥ç››å…¸ - é¸¿è¿å½“å¤´</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&family=Noto+Serif+SC:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <!-- å¼•å…¥ MQTT.js åº“ -->
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    
    <style>
        /* --- å…¨å±€ä¸èƒŒæ™¯ --- */
        html, body {
            height: 100%;
            width: 100%;
            /* ç¦æ­¢ç§»åŠ¨ç«¯æ©¡çš®ç­‹æ»šåŠ¨æ•ˆæœ */
            overscroll-behavior: none; 
        }
        body {
            margin: 0;
            overflow: hidden;
            background-color: #1a0505;
            background-image: 
                radial-gradient(circle at 50% 40%, #4a0000 0%, #000000 90%),
                url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23FFD700' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            font-family: 'Ma Shan Zheng', cursive;
            color: #FFD700;
            user-select: none;
            /* é€‚é…ç§»åŠ¨ç«¯é«˜åº¦ */
            min-height: 100dvh; 
        }

        #fireworks-canvas { position: absolute; top: 0; left: 0; z-index: 1; pointer-events: none; width: 100%; height: 100%; }
        #rain-canvas { position: absolute; top: 0; left: 0; z-index: 2; pointer-events: auto; width: 100%; height: 100%; }
        
        #ui-layer {
            position: relative;
            z-index: 10;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            /* ä½¿ç”¨ dvh ç¡®ä¿åœ¨æ‰‹æœºæµè§ˆå™¨ä¸­å±…ä¸­ä¸”ä¸è¢«åœ°å€æ é®æŒ¡ */
            height: 100dvh; 
            width: 100%;
            pointer-events: none; 
            /* å®‰å…¨åŒºå†…è¾¹è· */
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);
        }
        
        .interactive { pointer-events: auto; cursor: pointer; -webkit-tap-highlight-color: transparent; }

        /* --- éŸ³ä¹æ§åˆ¶æŒ‰é’® (é€‚é…å°å±) --- */
        #music-control {
            position: fixed;
            top: max(20px, env(safe-area-inset-top));
            right: max(20px, env(safe-area-inset-right));
            z-index: 50;
            width: 40px; /* æ‰‹æœºç«¯ç¨å° */
            height: 40px;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.4);
            border: 2px solid #FFD700;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #FFD700;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.3);
        }
        /* å¹³æ¿ä»¥ä¸Šè®¾å¤‡å˜å¤§ */
        @media (min-width: 768px) {
            #music-control { width: 50px; height: 50px; font-size: 20px; }
        }
        #music-control.playing {
            animation: spin 4s linear infinite;
            background: rgba(139, 0, 0, 0.6);
            box-shadow: 0 0 25px rgba(255, 215, 0, 0.6);
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* --- ä¾§è¾¹è®¸æ„¿æŒ‰é’® --- */
        #wish-btn {
            position: fixed;
            right: max(20px, env(safe-area-inset-right));
            bottom: max(20px, env(safe-area-inset-bottom));
            z-index: 50;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #d32f2f, #b71c1c);
            border: 2px solid #FFD700;
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #FFD700;
            font-size: 20px;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
            animation: bounce-slow 2s infinite;
        }
        @media (min-width: 768px) {
            #wish-btn { width: 60px; height: 60px; font-size: 24px; }
        }
        #wish-btn:active { transform: scale(0.9); }

        /* --- å¼¹çª—é€‚é… --- */
        #wish-modal {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            z-index: 60;
            display: none; 
            align-items: center;
            justify-content: center;
            padding: 20px; /* é˜²æ­¢è´´è¾¹ */
        }

        .modal-content {
            background: linear-gradient(to bottom, #800000, #4a0000);
            border: 2px solid #FFD700;
            border-radius: 20px;
            padding: 20px;
            width: 100%;
            max-width: 420px;
            text-align: center;
            box-shadow: 0 0 30px rgba(255, 0, 0, 0.5);
            position: relative;
            transform: scale(0.8);
            opacity: 0;
            transition: all 0.3s ease-out;
            /* æ‰‹æœºæ¨ªå±æ—¶é˜²æ­¢é«˜åº¦æº¢å‡º */
            max-height: 90vh;
            overflow-y: auto;
        }

        #wish-modal.active { display: flex; }
        #wish-modal.active .modal-content { transform: scale(1); opacity: 1; }

        .modal-input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border-radius: 8px;
            border: 1px solid #FFD700;
            background: rgba(255, 255, 255, 0.1);
            color: #FFD700;
            font-family: 'Ma Shan Zheng', cursive;
            font-size: 1.1rem;
            outline: none;
            text-align: center;
        }
        .modal-input::placeholder { color: rgba(255, 215, 0, 0.5); }

        /* --- AI æŒ‰é’®é€‚é… --- */
        .ai-tags-container {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            justify-content: center;
            margin-bottom: 15px;
        }
        .ai-tag {
            background: rgba(255, 215, 0, 0.15);
            border: 1px solid rgba(255, 215, 0, 0.4);
            color: #FFD700;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 4px;
            white-space: nowrap; /* é˜²æ­¢æ–‡å­—æ¢è¡Œ */
        }
        @media (min-width: 768px) {
            .ai-tag { padding: 5px 12px; font-size: 0.9rem; }
        }
        .ai-tag:active { background: rgba(255, 215, 0, 0.4); }

        /* --- ç¯ç¬¼è‡ªé€‚åº” --- */
        .lantern-box {
            position: absolute;
            top: -5px; /* æ‰‹æœºç«¯ç¨å¾®é ä¸Š */
            z-index: 20;
            transform-origin: 50% -20px;
            animation: swing-gentle 4s infinite ease-in-out alternate;
            /* é»˜è®¤æ‰‹æœºç«¯ç¼©æ”¾ */
            transform: scale(0.55);
        }
        @media (min-width: 640px) { .lantern-box { transform: scale(0.75); top: -10px; } }
        @media (min-width: 1024px) { .lantern-box { transform: scale(1); top: -10px; } }
        
        .lantern-wire { width: 4px; height: 60px; background: #b8860b; margin: 0 auto; }

        .lantern-body {
            width: 140px; height: 110px;
            background: radial-gradient(circle at 70% 30%, #ff4d4d, #a30000);
            border-radius: 50%;
            position: relative;
            box-shadow: 0 15px 50px rgba(255, 0, 0, 0.5);
            border: 1px solid #800000;
            display: flex; align-items: center; justify-content: center;
            z-index: 2;
        }
        .lantern-body::before {
            content: ''; position: absolute; top: 0; left: 25%; width: 50%; height: 100%;
            border-radius: 50%;
            border-left: 2px solid rgba(255, 215, 0, 0.3);
            border-right: 2px solid rgba(255, 215, 0, 0.3);
            pointer-events: none;
        }
        .lantern-body::after {
            content: ''; position: absolute; top: 0; left: 42%; width: 16%; height: 100%;
            border-radius: 50%;
            border-left: 1px solid rgba(255, 215, 0, 0.2);
            border-right: 1px solid rgba(255, 215, 0, 0.2);
            pointer-events: none;
        }

        .lantern-cap {
            width: 70px; height: 12px;
            background: linear-gradient(to right, #b8860b, #ffd700, #b8860b);
            margin: 0 auto; border-radius: 4px; position: relative; z-index: 3;
            box-shadow: 0 2px 5px rgba(0,0,0,0.5);
        }
        .cap-top { top: 6px; } .cap-bottom { bottom: 6px; }

        .lantern-tassel {
            width: 6px; height: 80px; background: #e60000; margin: -5px auto 0;
            position: relative; box-shadow: 0 5px 10px rgba(0,0,0,0.3);
        }
        .lantern-knot {
            width: 16px; height: 16px; background: #b8860b; border-radius: 50%;
            margin: 0 auto; position: relative; top: -5px; z-index: 4;
        }

        .lantern-text {
            font-size: 42px; color: #FFD700; font-weight: bold;
            text-shadow: 0 2px 4px rgba(139, 0, 0, 0.8); z-index: 5;
        }

        @keyframes swing-gentle { from { transform: rotate(-5deg); } to { transform: rotate(5deg); } }
        @keyframes bounce-slow { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }

        /* --- æ ‡é¢˜ä¸UI --- */
        .title-glow { text-shadow: 0 0 10px rgba(255, 215, 0, 0.3), 0 0 20px rgba(255, 0, 0, 0.4); }
        
        .btn-style {
            background: rgba(139, 0, 0, 0.6); backdrop-filter: blur(4px);
            border: 1px solid #FFD700; color: #FFD700; 
            padding: 8px 24px; /* ç§»åŠ¨ç«¯ */
            border-radius: 50px; font-size: 1rem; transition: all 0.3s ease;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.2);
            white-space: nowrap;
        }
        @media (min-width: 768px) { .btn-style { padding: 10px 30px; font-size: 1.2rem; } }
        .btn-style:active { transform: scale(0.95); }

        /* å€’è®¡æ—¶æ–¹å—è‡ªé€‚åº” */
        .countdown-item {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: rgba(80, 0, 0, 0.5); border: 1px solid rgba(255, 215, 0, 0.4);
            border-radius: 8px; 
            padding: 8px; 
            min-width: 60px; /* å…è®¸åœ¨å°å±ä¸Šæ›´çª„ */
            position: relative;
        }
        @media (min-width: 768px) { .countdown-item { padding: 15px; min-width: 90px; } }
    </style>
</head>
<body>

    <!-- éŸ³é¢‘é…ç½® -->
    <audio id="bgm" src="./bgm.mp3" loop preload="auto"></audio>
    <input type="file" id="music-upload" accept="audio/*" style="display: none;">

    <!-- èƒŒæ™¯å¤§â€œç¦â€å­— -->
    <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 pointer-events-none z-0 select-none w-full flex justify-center">
        <div class="font-['Ma_Shan_Zheng'] text-[50vw] md:text-[35vw] text-[#FFD700] leading-none opacity-20" 
             style="transform: rotate(180deg); filter: drop-shadow(0 0 30px rgba(255, 215, 0, 0.2)); text-shadow: 0 0 20px rgba(139, 0, 0, 0.5);">
            ç¦
        </div>
    </div>

    <canvas id="fireworks-canvas"></canvas>
    <canvas id="rain-canvas"></canvas>

    <!-- éŸ³ä¹æ§åˆ¶æŒ‰é’® -->
    <div id="music-control" class="interactive" onclick="window.toggleMusic()" data-tooltip="éŸ³ä¹å¼€å…³">
        <i class="fas fa-play"></i>
    </div>

    <!-- ä¾§è¾¹è®¸æ„¿æŒ‰é’® -->
    <div id="wish-btn" class="interactive" onclick="window.toggleModal(true)">
        <i class="fas fa-pen-nib"></i>
    </div>

    <!-- è®¸æ„¿å¼¹çª— -->
    <div id="wish-modal" onclick="if(event.target === this) window.toggleModal(false)">
        <div class="modal-content interactive">
            <h3 class="text-xl md:text-2xl text-yellow-400 font-bold mb-1">âœ¨ å†™ä¸‹æ–°å¹´ç¥ç¦ âœ¨</h3>
            <p class="text-red-200 text-xs md:text-sm mb-4">æ‚¨çš„ç¥ç¦å°†åŒ–ä½œé‡‘è‰²å¼¹å¹•åŒæ­¥ç»™æ‰€æœ‰äººï¼</p>
            
            <input type="text" id="wish-input" class="modal-input interactive" placeholder="ä¾‹å¦‚ï¼šå²å²å¹³å®‰" maxlength="12" onkeydown="if(event.key==='Enter') window.sendWish()">
            
            <!-- AI çµæ„ŸåŒºåŸŸ -->
            <div class="text-yellow-500/60 text-xs mb-2 text-left w-full pl-2">âœ¨ DeepSeek çµæ„ŸåŠ©æ‰‹ (ç‚¹å‡»è‡ªåŠ¨ç”Ÿæˆ):</div>
            <div class="ai-tags-container">
                <div class="ai-tag interactive" onclick="window.generateWish('ä¼ ç»Ÿå‰ç¥¥')">
                    <i class="fas fa-dragon"></i> ä¼ ç»Ÿå‰ç¥¥
                </div>
                <div class="ai-tag interactive" onclick="window.generateWish('é©¬å¹´è°éŸ³æ¢—')">
                    <i class="fas fa-horse"></i> é©¬å¹´è°éŸ³
                </div>
                <div class="ai-tag interactive" onclick="window.generateWish('äº‹ä¸šå­¦ä¸š')">
                    <i class="fas fa-graduation-cap"></i> æ­¥æ­¥é«˜å‡
                </div>
                <div class="ai-tag interactive" onclick="window.generateWish('å¹½é»˜ææ€ª')">
                    <i class="fas fa-laugh-wink"></i> å¹½é»˜ææ€ª
                </div>
            </div>

            <div class="flex gap-4 justify-center mt-4">
                <button onclick="window.toggleModal(false)" class="px-5 py-2 rounded-full border border-yellow-600 text-yellow-600 hover:bg-yellow-900/30 transition interactive text-sm md:text-base">å–æ¶ˆ</button>
                <button onclick="window.sendWish()" class="px-5 py-2 rounded-full bg-yellow-500 text-red-900 font-bold hover:bg-yellow-400 transition interactive shadow-[0_0_10px_rgba(255,215,0,0.5)] text-sm md:text-base">å‘é€ç¥ç¦</button>
            </div>
        </div>
    </div>

    <!-- ç¯ç¬¼ç»„ï¼šä½¿ç”¨ flex å¸ƒå±€æ›¿ä»£ç»å¯¹å®šä½ï¼Œé˜²æ­¢å°å±é‡å  -->
    <!-- æˆ‘ä»¬ä¿ç•™ç»å¯¹å®šä½ä½†ä½¿ç”¨ç™¾åˆ†æ¯”å’Œ CSS ç¼©æ”¾æ¥é€‚é… -->
    <div class="lantern-box left-[2%] md:left-[5%] origin-top">
        <div class="lantern-wire"></div> <div class="lantern-cap cap-top"></div>
        <div class="lantern-body"><span class="lantern-text">é©¬</span></div>
        <div class="lantern-cap cap-bottom"></div> <div class="lantern-knot"></div> <div class="lantern-tassel"></div>
    </div>
    <div class="lantern-box left-[25%] md:left-[20%] origin-top" style="animation-delay: -1s;">
        <div class="lantern-wire"></div> <div class="lantern-cap cap-top"></div>
        <div class="lantern-body"><span class="lantern-text">å¹´</span></div>
        <div class="lantern-cap cap-bottom"></div> <div class="lantern-knot"></div> <div class="lantern-tassel"></div>
    </div>
    <div class="lantern-box right-[25%] md:right-[20%] origin-top" style="animation-delay: -2.5s;">
        <div class="lantern-wire"></div> <div class="lantern-cap cap-top"></div>
        <div class="lantern-body"><span class="lantern-text">å¤§</span></div>
        <div class="lantern-cap cap-bottom"></div> <div class="lantern-knot"></div> <div class="lantern-tassel"></div>
    </div>
    <div class="lantern-box right-[2%] md:right-[5%] origin-top" style="animation-delay: -3.5s;">
        <div class="lantern-wire"></div> <div class="lantern-cap cap-top"></div>
        <div class="lantern-body"><span class="lantern-text">å‰</span></div>
        <div class="lantern-cap cap-bottom"></div> <div class="lantern-knot"></div> <div class="lantern-tassel"></div>
    </div>

    <div id="ui-layer">
        <div class="mb-4 sm:mb-8 text-center px-4">
            <div class="text-lg sm:text-xl md:text-2xl text-yellow-500/80 tracking-[0.5em] mb-2 sm:mb-4">å†œå†ä¸™åˆå¹´</div>
            <h1 class="text-5xl sm:text-6xl md:text-8xl font-black text-transparent bg-clip-text bg-gradient-to-b from-[#FFD700] to-[#FF8C00] title-glow m-0 leading-tight">
                æ–°æ˜¥å¤§å‰
            </h1>
            <div class="text-base sm:text-lg md:text-xl text-red-300 mt-2 sm:mt-4 tracking-widest font-serif opacity-80">
                HAPPY CHINESE NEW YEAR 2026
            </div>
        </div>

        <!-- å€’è®¡æ—¶: æ‰‹æœºç«¯ä½¿ç”¨ grid å¸ƒå±€é˜²æ­¢æº¢å‡ºï¼Œå¹³æ¿ä»¥ä¸Šä½¿ç”¨ flex -->
        <div class="grid grid-cols-4 gap-2 sm:flex sm:gap-4 md:gap-8 mb-8 sm:mb-12 px-2 w-full max-w-4xl justify-center">
            <div class="countdown-item">
                <span id="d" class="text-2xl sm:text-3xl md:text-5xl font-bold text-white">00</span>
                <span class="text-yellow-500/70 text-[10px] sm:text-xs mt-1">å¤©</span>
            </div>
            <div class="countdown-item">
                <span id="h" class="text-2xl sm:text-3xl md:text-5xl font-bold text-white">00</span>
                <span class="text-yellow-500/70 text-[10px] sm:text-xs mt-1">æ—¶</span>
            </div>
            <div class="countdown-item">
                <span id="m" class="text-2xl sm:text-3xl md:text-5xl font-bold text-white">00</span>
                <span class="text-yellow-500/70 text-[10px] sm:text-xs mt-1">åˆ†</span>
            </div>
            <div class="countdown-item">
                <span id="s" class="text-2xl sm:text-3xl md:text-5xl font-bold text-red-400">00</span>
                <span class="text-yellow-500/70 text-[10px] sm:text-xs mt-1">ç§’</span>
            </div>
        </div>

        <div class="flex gap-4 sm:gap-6">
            <button onclick="window.triggerSalute()" class="interactive btn-style">
                âœ¨ ç‡ƒæ”¾çƒŸèŠ±
            </button>
        </div>
        
        <div id="score-board" class="mt-4 sm:mt-6 text-lg sm:text-xl text-yellow-200/80 font-light transition-opacity">
            å·²é›†ç¦æ°”: <span id="score" class="text-yellow-400 font-bold text-xl sm:text-2xl mx-1">0</span> 
        </div>
        <div class="text-xs sm:text-sm text-yellow-500/40 mt-2">ç‚¹å‡»é£˜è½çš„çº¢åŒ…æ”¶è·å¥½è¿</div>
    </div>

    <!-- é€»è¾‘è„šæœ¬ -->
    <script>
        // --- å…¨å±€å˜é‡å®šä¹‰ ---
        const targetDate = new Date('February 17, 2026 00:00:00').getTime();
        const deepseekApiKey = "sk-ae653d972e284b29a68739f1f53aa2a5"; 

        // --- 1. MQTT å®æ—¶é€šä¿¡ (æ ¸å¿ƒ) ---
        const mqttClient = mqtt.connect('wss://broker.emqx.io:8084/mqtt', {
            clientId: 'cny_2026_' + Math.random().toString(16).substr(2, 8),
            keepalive: 60,
            reconnectPeriod: 1000
        });
        const mqttTopic = 'hny2026/wishes/live';

        let wishesPool = [
            "æ–°å¹´å¿«ä¹", "æ­å–œå‘è´¢", "é©¬åˆ°æˆåŠŸ", "èº«ä½“å¥åº·", "ä¸‡äº‹å¦‚æ„", "è´¢æºæ»šæ»š", 
            "å¿ƒæƒ³äº‹æˆ", "åˆå®¶æ¬¢ä¹", "é¾™é©¬ç²¾ç¥", "äº‹ä¸šæœ‰æˆ", "å‰ç¥¥å¦‚æ„", "ç¦æ°”æ»¡æ»¡",
            "æ­¥æ­¥é«˜å‡", "ç¬‘å£å¸¸å¼€", "äº”ç¦ä¸´é—¨", "é‡‘ç‰æ»¡å ‚", "è¿æ˜¥æ¥ç¦", "é¸¿è¿å½“å¤´"
        ];

        mqttClient.on('connect', () => {
            console.log('MQTT Connected');
            mqttClient.subscribe(mqttTopic);
        });

        mqttClient.on('message', (topic, message) => {
            try {
                const msgData = JSON.parse(message.toString());
                const text = msgData.text;
                const senderId = msgData.id;
                
                if (wishesPool.length > 100) wishesPool.shift(); 
                if (!wishesPool.includes(text)) wishesPool.push(text);

                if (senderId !== mqttClient.options.clientId) {
                    danmakus.push(new Danmaku(text, false)); 
                    createFirework(Math.random() * window.innerWidth, window.innerHeight * 0.4);
                }
            } catch (e) { }
        });

        // --- DeepSeek API è°ƒç”¨ ---
        window.generateWish = async function(category) {
            const input = document.getElementById('wish-input');
            input.value = "AI æ€è€ƒä¸­...";
            input.disabled = true;
            
            const systemPrompt = "You are a creative assistant helping write short Chinese New Year wishes (max 12 chars).";
            const userPrompt = `Generate a very short Chinese New Year wish (max 12 Chinese characters) for the Year of the Horse 2026. Category: ${category}. Style: Festive, creative. Output ONLY the wish text.`;

            try {
                const response = await fetch('https://api.deepseek.com/chat/completions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${deepseekApiKey}` },
                    body: JSON.stringify({ model: "deepseek-chat", messages: [{ role: "system", content: systemPrompt }, { role: "user", content: userPrompt }], stream: false })
                });

                if (!response.ok) throw new Error('API Error');
                const data = await response.json();
                const aiText = data.choices?.[0]?.message?.content?.trim() || "é©¬å¹´å¤§å‰ï¼";
                input.value = aiText.replace(/['"ã€Šã€‹]/g, '');
            } catch (error) {
                console.error("AI Error:", error);
                input.value = wishesPool[Math.floor(Math.random() * wishesPool.length)];
                showFloatingText(window.innerWidth/2, window.innerHeight/2, "å·²éšæœºç”Ÿæˆ");
            } finally {
                input.disabled = false;
                input.focus();
            }
        };

        // --- æ¨¡æ‹Ÿ/å¾ªç¯å¼¹å¹•é€»è¾‘ ---
        function simulateRemoteWishes() {
            const delay = Math.random() * 1200 + 800; 
            setTimeout(() => {
                const text = wishesPool[Math.floor(Math.random() * wishesPool.length)];
                if (danmakus.length < 25) danmakus.push(new Danmaku(text, false));
                if (Math.random() < 0.15) createFirework(Math.random() * fCanvas.width, Math.random() * fCanvas.height * 0.5);
                simulateRemoteWishes();
            }, delay);
        }
        simulateRemoteWishes();

        // --- å‘é€ç¥ç¦ ---
        window.sendWish = function() {
            const input = document.getElementById('wish-input');
            const text = input.value.trim();
            if (!text) return;
            
            danmakus.push(new Danmaku(text, true)); 
            createFirework(window.innerWidth / 2, window.innerHeight / 2);
            if (!wishesPool.includes(text)) wishesPool.push(text);

            input.value = '';
            window.toggleModal(false);
            showFloatingText(window.innerWidth/2, window.innerHeight/2, "å‘é€æˆåŠŸ âœ¨");

            if (mqttClient.connected) {
                const payload = JSON.stringify({ text: text, id: mqttClient.options.clientId });
                mqttClient.publish(mqttTopic, payload);
            }
        };

        // --- éŸ³ä¹ã€åŠ¨ç”»ã€å€’è®¡æ—¶é€»è¾‘ ---
        const bgm = document.getElementById('bgm');
        const musicBtn = document.getElementById('music-control');
        const musicUpload = document.getElementById('music-upload');
        let musicStarted = false;
        let isManualMode = false;

        function tryPlayMusic() {
            if (musicStarted || isManualMode) return;
            if (bgm.error) return;
            const playPromise = bgm.play();
            if (playPromise !== undefined) {
                playPromise.then(() => {
                    musicBtn.classList.add('playing');
                    musicBtn.innerHTML = '<i class="fas fa-compact-disc"></i>'; 
                    showFloatingText(window.innerWidth/2, window.innerHeight/2, "éŸ³ä¹å¼€å¯ ğŸ¶");
                    musicStarted = true;
                }).catch(error => {});
            }
        }

        window.toggleMusic = function() {
            if (isManualMode) { musicUpload.click(); return; }
            if (bgm.paused) {
                bgm.play().then(() => {
                    musicBtn.classList.add('playing');
                    musicBtn.innerHTML = '<i class="fas fa-compact-disc"></i>'; 
                    showFloatingText(window.innerWidth/2, window.innerHeight/2, "æ’­æ”¾ â–¶ï¸");
                    musicStarted = true;
                }).catch(e => {
                    showFloatingText(window.innerWidth/2, window.innerHeight/2, "è¯·ç‚¹å‡»é¡µé¢ä»»æ„å¤„ ğŸ‘‡");
                });
            } else {
                bgm.pause();
                musicBtn.classList.remove('playing');
                musicBtn.innerHTML = '<i class="fas fa-play"></i>';
                showFloatingText(window.innerWidth/2, window.innerHeight/2, "æš‚åœ â¸ï¸");
            }
        };

        bgm.onerror = function() {
            isManualMode = true;
            musicBtn.innerHTML = '<i class="fas fa-folder-open"></i>';
            musicBtn.setAttribute('data-tooltip', 'é€‰æ‹©æ–‡ä»¶');
        };

        musicUpload.addEventListener('change', function(e) {
            const file = e.target.files[0];
            musicUpload.value = '';
            if (!file) return;
            if (bgm.src && bgm.src.startsWith('blob:')) URL.revokeObjectURL(bgm.src);
            bgm.src = URL.createObjectURL(file);
            isManualMode = false;
            bgm.play().then(() => {
                musicBtn.classList.add('playing');
                musicBtn.innerHTML = '<i class="fas fa-compact-disc"></i>';
                musicStarted = true;
            });
        });

        document.body.addEventListener('click', tryPlayMusic, { once: true });
        document.body.addEventListener('touchstart', tryPlayMusic, { once: true });
        
        const fCanvas = document.getElementById('fireworks-canvas');
        const fCtx = fCanvas.getContext('2d');
        const rCanvas = document.getElementById('rain-canvas');
        const rCtx = rCanvas.getContext('2d');
        let particles = [];
        let drops = []; 
        let score = 0;
        let danmakus = [];

        function resize() {
            fCanvas.width = window.innerWidth;
            fCanvas.height = window.innerHeight;
            rCanvas.width = window.innerWidth;
            rCanvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resize);
        resize();

        class Danmaku {
            constructor(text, isUser = false) {
                this.text = text;
                this.x = rCanvas.width;
                // é€‚é…æ‰‹æœºå±å¹•ï¼Œå¼¹å¹•åŒºåŸŸæ›´åˆç†
                const topMargin = window.innerHeight * 0.1;
                const areaHeight = window.innerHeight * 0.6;
                this.y = Math.random() * areaHeight + topMargin; 
                this.speed = Math.random() * 2 + 1.5;
                if (window.innerWidth < 768) this.speed *= 0.8; // æ‰‹æœºç«¯å‡é€Ÿ
                this.color = isUser ? "#FFF700" : `rgba(255, 215, 0, ${Math.random() * 0.4 + 0.4})`;
                // å­—ä½“å¤§å°è‡ªé€‚åº”
                const baseSize = window.innerWidth < 768 ? 20 : 30;
                this.fontSize = isUser ? `bold ${baseSize + 4}px` : `${Math.floor(Math.random() * 8 + baseSize)}px`;
                this.shadowBlur = isUser ? 20 : 0;
            }
            update() { this.x -= this.speed; }
            draw() {
                rCtx.font = `${this.fontSize} 'Ma Shan Zheng'`;
                rCtx.fillStyle = this.color;
                rCtx.shadowColor = "#FF0000";
                rCtx.shadowBlur = this.shadowBlur;
                rCtx.fillText(this.text, this.x, this.y);
                rCtx.shadowBlur = 0;
            }
        }

        // åˆå§‹å¼¹å¹•
        for(let i=0; i<20; i++) {
            const d = new Danmaku(wishesPool[Math.floor(Math.random() * wishesPool.length)]);
            d.x = Math.random() * rCanvas.width;
            danmakus.push(d);
        }

        class Particle {
            constructor(x, y, hue) {
                this.x = x; this.y = y; this.hue = hue;
                const angle = Math.random() * Math.PI * 2;
                const speed = Math.random() * 4 + 2;
                this.vx = Math.cos(angle) * speed;
                this.vy = Math.sin(angle) * speed;
                this.friction = 0.96; this.gravity = 0.08;
                this.alpha = 1; this.decay = Math.random() * 0.015 + 0.005;
            }
            update() {
                this.vx *= this.friction; this.vy *= this.friction;
                this.vy += this.gravity;
                this.x += this.vx; this.y += this.vy;
                this.alpha -= this.decay;
            }
            draw() {
                fCtx.globalAlpha = this.alpha;
                fCtx.fillStyle = `hsl(${this.hue}, 100%, 60%)`;
                fCtx.beginPath(); fCtx.arc(this.x, this.y, 2.5, 0, Math.PI * 2); fCtx.fill();
            }
        }

        function createFirework(x, y) {
            const hue = Math.floor(Math.random() * 60) + 330;
            for (let i = 0; i < 60; i++) { particles.push(new Particle(x, y, hue)); }
        }
        window.createFirework = createFirework;

        function animateFireworks() {
            fCtx.globalCompositeOperation = 'destination-out';
            fCtx.fillStyle = 'rgba(0, 0, 0, 0.2)'; 
            fCtx.fillRect(0, 0, fCanvas.width, fCanvas.height);
            fCtx.globalCompositeOperation = 'source-over'; 
            particles.forEach((p, i) => {
                p.update(); p.draw();
                if (p.alpha <= 0) particles.splice(i, 1);
            });
            requestAnimationFrame(animateFireworks);
        }
        animateFireworks();

        class Drop {
            constructor(type) {
                this.type = type; 
                this.x = Math.random() * rCanvas.width;
                this.y = -60;
                // æ‰‹æœºç«¯ç¨å¾®ç¼©å°
                let scale = type === 'hongbao' ? (Math.random() * 0.6 + 0.7) : (Math.random() * 0.5 + 0.8);
                if (window.innerWidth < 768) scale *= 0.8;
                
                this.w = (type === 'hongbao' ? 36 : 10) * scale;
                this.h = (type === 'hongbao' ? 50 : 10) * scale;
                this.vy = type === 'hongbao' ? Math.random() * 1.5 + 1 : Math.random() * 1 + 0.5;
                this.vx = Math.random() * 1 - 0.5;
                this.rot = Math.random() * 360;
                this.rotSpeed = Math.random() * 1 - 0.5;
                this.radius = Math.max(this.w, this.h) / 2;
            }
            update() {
                this.y += this.vy;
                this.x += this.vx + Math.sin(this.y / 50) * 0.5;
                this.rot += this.rotSpeed;
                return (this.y < rCanvas.height + 60);
            }
            draw() {
                rCtx.save();
                rCtx.translate(this.x, this.y);
                rCtx.rotate(this.rot * Math.PI / 180);
                if (this.type === 'hongbao') {
                    rCtx.fillStyle = '#c62828';
                    rCtx.fillRect(-this.w/2, -this.h/2, this.w, this.h);
                    rCtx.strokeStyle = '#e53935';
                    rCtx.beginPath(); rCtx.moveTo(-this.w/2, -this.h/4);
                    rCtx.quadraticCurveTo(0, 0, this.w/2, -this.h/4); rCtx.stroke();
                    rCtx.fillStyle = '#FFD700';
                    rCtx.beginPath(); rCtx.arc(0, this.h * 0.1, this.w * 0.16, 0, Math.PI*2); rCtx.fill();
                    rCtx.fillStyle = '#c62828';
                    // å­—ä½“é€‚é…
                    const fontSize = Math.floor(this.w * 0.22);
                    rCtx.font = `${fontSize}px Arial`; rCtx.textAlign = "center";
                    rCtx.textBaseline = "middle"; rCtx.fillText("ç¦", 0, this.h * 0.1);
                } else {
                    rCtx.fillStyle = `rgba(255, 215, 0, ${Math.random() * 0.5 + 0.5})`;
                    rCtx.beginPath(); rCtx.arc(0, 0, this.w/2, 0, Math.PI*2); rCtx.fill();
                }
                rCtx.restore();
            }
        }

        for(let i=0; i<20; i++) drops.push(new Drop('flower'));

        function animateRainAndDanmaku() {
            rCtx.clearRect(0, 0, rCanvas.width, rCanvas.height);
            if (Math.random() < 0.008) drops.push(new Drop('hongbao'));
            if (drops.filter(d => d.type === 'flower').length < 25 && Math.random() < 0.05) drops.push(new Drop('flower'));

            drops = drops.filter(d => {
                const alive = d.update();
                d.draw();
                return alive;
            });
            danmakus = danmakus.filter(d => {
                d.update();
                d.draw();
                return d.x + 500 > 0;
            });
            requestAnimationFrame(animateRainAndDanmaku);
        }
        animateRainAndDanmaku();

        window.triggerSalute = function() {
            for(let i=0; i<5; i++) {
                setTimeout(() => {
                    createFirework(Math.random()*fCanvas.width, Math.random()*fCanvas.height*0.6);
                }, i*300);
            }
        };

        window.toggleModal = function(show) {
            const modal = document.getElementById('wish-modal');
            if (show) {
                modal.classList.add('active');
                setTimeout(() => document.getElementById('wish-input').focus(), 100);
            } else {
                modal.classList.remove('active');
            }
        };

        function showFloatingText(x, y, text) {
            const el = document.createElement('div');
            el.style.position = 'absolute'; el.style.left = x + 'px'; el.style.top = y + 'px';
            el.style.color = '#FFD700'; el.style.fontWeight = 'bold'; el.style.fontSize = '24px';
            el.style.pointerEvents = 'none'; el.style.zIndex = '100';
            el.style.textShadow = '0 2px 5px rgba(0,0,0,0.5)';
            el.style.animation = 'floatUp 1s ease-out forwards';
            el.innerText = text;
            const style = document.createElement('style');
            style.innerHTML = `@keyframes floatUp { 0% { opacity:1; transform:translateY(0); } 100% { opacity:0; transform:translateY(-50px); } }`;
            document.head.appendChild(style);
            document.body.appendChild(el);
            setTimeout(() => { el.remove(); style.remove(); }, 1000);
        }

        function checkClick(x, y) {
            let hit = false;
            // UIé®æŒ¡æ£€æŸ¥
            const musicBtn = document.getElementById('music-control');
            const mRect = musicBtn.getBoundingClientRect();
            if (x >= mRect.left && x <= mRect.right && y >= mRect.top && y <= mRect.bottom) return;
            const wRect = document.getElementById('wish-btn').getBoundingClientRect();
            if (x >= wRect.left && x <= wRect.right && y >= wRect.top && y <= wRect.bottom) return;
            
            if (document.getElementById('wish-modal').classList.contains('active')) return;

            for (let i = drops.length - 1; i >= 0; i--) {
                const d = drops[i];
                if (d.type === 'hongbao') {
                    const dx = x - d.x; const dy = y - d.y;
                    if (Math.sqrt(dx*dx + dy*dy) < d.radius + 20) { // å¢åŠ ç‚¹å‡»åˆ¤å®šèŒƒå›´
                        drops.splice(i, 1); hit = true;
                        const amount = [66, 88, 168, 666, 888][Math.floor(Math.random()*5)];
                        score += amount;
                        document.getElementById('score').innerText = score;
                        showFloatingText(x, y, `+${amount}`);
                        createFirework(x, y);
                        break;
                    }
                }
            }
            if (!hit) createFirework(x, y);
        }

        document.addEventListener('mousedown', e => checkClick(e.clientX, e.clientY));
        document.addEventListener('touchstart', e => {
            for (let i = 0; i < e.touches.length; i++) {
                checkClick(e.touches[i].clientX, e.touches[i].clientY);
            }
        }, {passive: false});
        
        setInterval(() => {
            if (Math.random() < 0.2) createFirework(Math.random()*fCanvas.width, Math.random()*fCanvas.height*0.5);
        }, 2000);

        function updateT() {
            const now = new Date().getTime();
            let distance = targetDate - now;
            if (distance < 0) distance += 31536000000;
            dEl.innerText = Math.floor(distance / (1000 * 60 * 60 * 24)).toString().padStart(2,'0');
            hEl.innerText = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60)).toString().padStart(2,'0');
            mEl.innerText = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60)).toString().padStart(2,'0');
            sEl.innerText = Math.floor((distance % (1000 * 60)) / 1000).toString().padStart(2,'0');
        }
        const dEl = document.getElementById('d');
        const hEl = document.getElementById('h');
        const mEl = document.getElementById('m');
        const sEl = document.getElementById('s');
        setInterval(updateT, 1000);
        updateT();
    </script>
</body>
</html>
